name: Video Master - Ultimate iPhone Edition

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'
        required: true
      episode_name:
        description: 'Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© (Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)'
        required: true

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools (yt-dlp & FFmpeg)
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download & iPhone Encoding
        run: |
          mkdir -p output
          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ù†ÙˆØ¹Ù‡ (MKV, WEBM, etc)
          yt-dlp -f "bestvideo+bestaudio/best" \
          --merge-output-format mp4 \
          -o "output/raw_video.mp4" \
          "${{ github.event.inputs.video_url }}"

          # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±Ù…ÙŠØ² Ù„ÙŠÙƒÙˆÙ† H.264 + AAC (Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„Ù„Ø§ÙŠÙÙˆÙ†)
          ffmpeg -i output/raw_video.mp4 -c:v libx264 -preset fast -crf 23 -c:a aac -b:a 128k "output/${{ github.event.inputs.episode_name }}.mp4"
          rm output/raw_video.mp4

      - name: Upload to Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: "output/*.mp4"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Direct iPhone Link
        run: |
          # ÙƒÙˆØ¯ Ø¨Ø§ÙŠØ«ÙˆÙ† Ù„Ø¶Ù…Ø§Ù† ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø±ÙˆØ§Ø¨Ø· ØµØ§Ù„Ø­Ø© 100%
          REPO="${{ github.repository }}"
          RUN_ID="v${{ github.run_number }}"
          FILE_NAME="${{ github.event.inputs.episode_name }}.mp4"
          
          PYTHON_LINK=$(python3 -c "import urllib.parse; print(f'https://github.com/{ \"$REPO\" }/releases/download/{ \"$RUN_ID\" }/' + urllib.parse.quote('$FILE_NAME'))")
          
          echo "=========================================================="
          echo "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ÙŠØ§ Ø¨Ø·Ù„!"
          echo "ğŸ“¦ Ø§Ù„Ø­Ù„Ù‚Ø©: ${{ github.event.inputs.episode_name }}"
          echo "ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ù†Ø³Ø®Ù‡ Ù„Ù„Ø§ÙŠÙÙˆÙ†):"
          echo "$PYTHON_LINK"
          echo "=========================================================="

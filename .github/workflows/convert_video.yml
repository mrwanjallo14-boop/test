name: Video Master - iPhone Ready

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'رابط الفيديو'
        required: true
      episode_name:
        description: 'اسم الحلقة (عربي أو إنجليزي)'
        required: true

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download and Convert
        run: |
          mkdir -p output
          # تحميل بأعلى جودة وتغيير الاسم للاسم المطلوب
          yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best" \
          --merge-output-format mp4 \
          -o "output/${{ github.event.inputs.episode_name }}.mp4" \
          "${{ github.event.inputs.video_url }}"

      - name: Upload to Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: "output/*.mp4"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate iPhone Link
        run: |
          # كود بايثون لضمان عمل الحروف العربية في الروابط
          REPO="${{ github.repository }}"
          RUN_ID="v${{ github.run_number }}"
          FILE_NAME="${{ github.event.inputs.episode_name }}.mp4"
          
          PYTHON_LINK=$(python3 -c "import urllib.parse; print(f'https://github.com/{ \"$REPO\" }/releases/download/{ \"$RUN_ID\" }/' + urllib.parse.quote('$FILE_NAME'))")
          
          echo "=========================================================="
          echo "تم الإنجاز بنجاح!"
          echo "الرابط المباشر (انسخه وضعه في المتصفح):"
          echo "$PYTHON_LINK"
          echo "=========================================================="

name: Video Downloader - Fast & Direct

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'رابط الفيديو'
        required: true
      episode_name:
        description: 'اسم الحلقة'
        required: true

jobs:
  convert_and_link:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download
        run: |
          mkdir -p output
          yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best" \
          --merge-output-format mp4 \
          -o "output/${{ github.event.inputs.episode_name }}.mp4" \
          "${{ github.event.inputs.video_url }}"

      - name: Upload
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: "output/${{ github.event.inputs.episode_name }}.mp4"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print Direct Link
        run: |
          # تنظيف الاسم وتجهيز الرابط النهائي
          CLEAN_NAME=$(echo "${{ github.event.inputs.episode_name }}.mp4" | sed 's/ /./g')
          DIRECT_LINK="https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/$CLEAN_NAME"
          
          echo "=========================================================="
          echo "تم الإنجاز! الرابط المباشر لحلقتك هو:"
          echo "$DIRECT_LINK"
          echo "=========================================================="

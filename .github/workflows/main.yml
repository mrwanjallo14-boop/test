name: Video Converter & JSON Factory
on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'رابط الفيديو'
        required: true
      video_name:
        description: 'اسم الفيديو'
        required: true

jobs:
  process-and-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install yt-dlp

      - name: Create Videos Directory
        run: mkdir -p videos # هذا السطر هو الحل للمشكلة الأخيرة

      - name: Download & Convert to Safari MP4
        run: |
          # تحميل الفيديو بأفضل جودة ممكنة
          yt-dlp -f "bestvideo+bestaudio/best" "${{ github.event.inputs.video_url }}" -o "raw_video"
          
          # التحويل بصيغة Safari (h264 + aac) مع ضمان وجود المجلد
          ffmpeg -i raw_video -vcodec libx264 -acodec aac -movflags +faststart "videos/${{ github.event.inputs.video_name }}.mp4"

      - name: Commit Video to Repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add videos/*.mp4
          git commit -m "إضافة فيديو جديد: ${{ github.event.inputs.video_name }}"
          git push

      - name: Generate JSON File
        run: |
          # الرابط المباشر من GitHub
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/videos/${{ github.event.inputs.video_name }}.mp4"
          
          # تنسيق JSON جاهز للإضافة دون مسح البيانات
          echo "{" > video_info.json
          echo "  \"name\": \"${{ github.event.inputs.video_name }}\"," >> video_info.json
          echo "  \"url\": \"$REPO_URL\"," >> video_info.json
          echo "  \"groupId\": \"لوس\"" >> video_info.json
          echo "}" >> video_info.json

      - name: Download Your JSON
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.video_name }}-JSON
          path: video_info.json
